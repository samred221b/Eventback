import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  ScrollView,
  TouchableOpacity,
  Image,
  Alert,
  StatusBar,
  ActivityIndicator,
  Modal,
  TextInput,
} from 'react-native';
import { useFocusEffect } from '@react-navigation/native';
import { Feather } from '@expo/vector-icons';

import { useAuth } from '../providers/AuthProvider';
import { SafeScrollView, SafeTouchableOpacity } from '../components/SafeComponents';

import styles from '../styles';
import { formatDate, parseBoolean } from '../utils/dataProcessor';
import apiService from '../services/api';

export default function OrganizerDashboard({ navigation }) {
  const { user, organizerProfile, signOut } = useAuth();
  const [organizerEvents, setOrganizerEvents] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [insights, setInsights] = useState({
    totalViews: 0,
    totalLikes: 0,
    growthRate: 0,
    topCategory: 'N/A'
  });
  
  useEffect(() => {
    loadOrganizerEvents();
  }, []);

  useFocusEffect(
    React.useCallback(() => {
      loadOrganizerEvents();
    }, [])
  );
  
  const loadOrganizerEvents = async () => {
    try {
      setIsLoading(true);
      const response = await apiService.getOrganizerEvents();
      
      if (response.success && response.data) {
        const events = response.data.map(event => ({
          id: event._id,
          title: event.title,
          date: event.date,
          time: event.time,
          status: getEventStatus(event.date),
          attendees: event.attendeeCount || 0,
          category: event.category,
          price: event.price || 0,
          views: event.views || 0,
          likes: event.likeCount || 0,
          location: event.location,
          description: event.description,
          featured: event.featured
        }));
        
        setOrganizerEvents(events);
        calculateInsights(events);
      } else {
        const allEventsResponse = await apiService.getEvents();
        if (allEventsResponse.success && allEventsResponse.data) {
          const events = allEventsResponse.data.map(event => ({
            id: event._id,
            title: event.title,
            date: event.date,
            time: event.time,
            status: getEventStatus(event.date),
            attendees: event.attendeeCount || 0,
            category: event.category,
            price: event.price || 0,
            views: event.views || 0,
            likes: event.likeCount || 0,
            location: event.location,
            description: event.description,
            featured: event.featured
          }));
          
          setOrganizerEvents(events);
          calculateInsights(events);
        }
      }
    } catch (error) {
      console.error('Error loading organizer events:', error);
    } finally {
      setIsLoading(false);
    }
  };
  
  const getEventStatus = (dateString) => {
    const eventDate = new Date(dateString);
    const now = new Date();
    const daysDiff = Math.floor((eventDate - now) / (1000 * 60 * 60 * 24));
    
    if (daysDiff < 0) return 'Ended';
    if (daysDiff === 0) return 'Today';
    if (daysDiff <= 7) return 'This Week';
    return 'Upcoming';
  };
  
  const calculateInsights = (events) => {
    if (events.length === 0) {
      setInsights({ totalViews: 0, totalLikes: 0, growthRate: 0, topCategory: 'N/A' });
      return;
    }

    const totalViews = events.reduce((sum, e) => sum + (e.views || 0), 0);
    const totalLikes = events.reduce((sum, e) => sum + (e.likes || 0), 0);
    
    const categories = {};
    events.forEach(e => {
      if (e.category) {
        categories[e.category] = (categories[e.category] || 0) + 1;
      }
    });
    
    const topCategory = Object.keys(categories).length > 0 
      ? Object.keys(categories).reduce((a, b) => categories[a] > categories[b] ? a : b)
      : 'N/A';
    
    const now = new Date();
    const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());
    const recentEvents = events.filter(e => new Date(e.date) >= lastMonth);
    const growthRate = events.length > 0 
      ? ((recentEvents.length / events.length) * 100).toFixed(1)
      : 0;
    
    setInsights({
      totalViews,
      totalLikes,
      growthRate: parseFloat(growthRate),
      topCategory: topCategory.charAt(0).toUpperCase() + topCategory.slice(1)
    });
  };
  
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [newEvent, setNewEvent] = useState({
    title: '',
    category: '',
    description: '',
    location: '',
    startDate: '',
    endDate: '',
    price: ''
  });

  const dashboardProfile = {
    name: organizerProfile?.name || user?.displayName || user?.email?.split('@')[0] || 'Organizer',
    email: organizerProfile?.email || user?.email || '',
    avatar: '?????',
    totalEvents: organizerProfile?.totalEvents || organizerEvents.length,
    activeEvents: organizerEvents.filter(e => e.status !== 'Ended').length,
    totalAttendees: organizerEvents.reduce((sum, event) => sum + event.attendees, 0),
    isVerified: organizerProfile?.isVerified || false
  };

  const handleSignOut = async () => {
    Alert.alert(
      'Log Out',
      'Are you sure you want to log out of your account?',
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Log Out',
          style: 'destructive',
          onPress: async () => {
            try {
              const result = await signOut();
              if (result.success) {
                navigation.navigate('OrganizerLogin');
              }
            } catch (error) {
              console.error('Sign out error:', error);
            }
          }
        }
      ]
    );
  };

  const handleDeleteEvent = (eventId) => {
    Alert.alert(
      'Delete Event',
      'Are you sure you want to delete this event? This action cannot be undone.',
      [
        { text: 'Cancel', style: 'cancel' },
        {
          text: 'Delete',
          style: 'destructive',
          onPress: async () => {
            try {
              const response = await apiService.deleteEvent(eventId);
              if (response.success) {
                setOrganizerEvents(prev => prev.filter(e => e.id !== eventId));
                Alert.alert('Success', 'Event deleted successfully');
              } else {
                Alert.alert('Error', response.message || 'Failed to delete event');
              }
            } catch (error) {
              Alert.alert('Error', error.message || 'Failed to delete event');
            }
          }
        }
      ]
    );
  };
  
  const handleEditEvent = (event) => {
    navigation.navigate('CreateEvent', { editEvent: event });
  };
  
  const renderEventCard = (event) => (
    <SafeTouchableOpacity 
      key={event.id} 
      style={styles.dashboardEventCard}
      activeOpacity={0.95}
    >
      <View style={styles.dashboardEventHeader}>
        <View style={styles.dashboardEventInfo}>
          <View style={styles.dashboardEventIconContainer}>
            <Text style={styles.dashboardEventIcon}>
              {event.category === 'music' ? '??' :
               event.category === 'technology' ? '??' :
               event.category === 'art' ? '??' :
               event.category === 'food' ? '???' :
               event.category === 'sports' ? '?' : '??'}
            </Text>
          </View>
          <View style={styles.dashboardEventDetails}>
            <Text style={styles.dashboardEventTitle} numberOfLines={1}>{event.title}</Text>
            <Text style={styles.dashboardEventDate}>?? {formatDate(event.date)} ï¿½ {event.time}</Text>
            <View style={styles.dashboardEventMeta}>
              <View style={[styles.dashboardEventStatus, 
                event.status === 'Upcoming' || event.status === 'This Week' ? styles.statusUpcoming :
                event.status === 'Today' ? styles.statusOngoing : styles.statusEnded
              ]}>
                <Text style={styles.dashboardEventStatusText}>{event.status}</Text>
              </View>
              <Text style={styles.dashboardEventViews}>??? {event.views}</Text>
              <Text style={styles.dashboardEventFavorites}>?? {event.likes}</Text>
            </View>
          </View>
        </View>
        <View style={styles.dashboardEventActions}>
          <SafeTouchableOpacity 
            style={[styles.dashboardActionButton, styles.editButton]}
            onPress={() => handleEditEvent(event)}
            activeOpacity={0.7}
          >
            <Text style={styles.dashboardActionIcon}>??</Text>
          </SafeTouchableOpacity>
          <SafeTouchableOpacity 
            style={[styles.dashboardActionButton, styles.deleteButton]}
            onPress={() => handleDeleteEvent(event.id)}
            activeOpacity={0.7}
          >
            <Text style={styles.dashboardActionIcon}>???</Text>
          </SafeTouchableOpacity>
        </View>
      </View>
    </SafeTouchableOpacity>
  );

  return (
    <SafeScrollView 
      style={styles.modernDashboardContainer}
      showsVerticalScrollIndicator={false}
      bounces={true}
      scrollEnabled={true}
      nestedScrollEnabled={true}
      keyboardShouldPersistTaps="handled"
    >
      <StatusBar 
        style="light" 
        hidden={false}
        translucent={false}
      />
      
      <View style={styles.modernDashboardHeader}>
        <View style={styles.modernDashboardHeaderTop}>
          <View style={styles.modernDashboardProfile}>
            <View style={styles.modernDashboardAvatar}>
              <Feather name="user" size={28} color="#FFFFFF" />
            </View>
            <View style={styles.modernDashboardProfileInfo}>
              <Text style={styles.modernDashboardWelcome}>Welcome back,</Text>
              <Text style={styles.modernDashboardName}>{dashboardProfile.name}</Text>
            </View>
          </View>
          
          <SafeTouchableOpacity 
            style={styles.modernDashboardSettingsButton}
            onPress={handleSignOut}
            activeOpacity={0.7}
          >
            <Feather name="log-out" size={22} color="#FFFFFF" />
          </SafeTouchableOpacity>
        </View>

        <View style={styles.modernDashboardStatsContainer}>
          <View style={styles.modernDashboardStatCard}>
            <View style={styles.modernDashboardStatIconContainer}>
              <Feather name="calendar" size={20} color="#0277BD" />
            </View>
            <Text style={styles.modernDashboardStatNumber}>{dashboardProfile.totalEvents}</Text>
            <Text style={styles.modernDashboardStatLabel}>Total Events</Text>
          </View>

          <View style={styles.modernDashboardStatCard}>
            <View style={styles.modernDashboardStatIconContainer}>
              <Feather name="activity" size={20} color="#0277BD" />
            </View>
            <Text style={styles.modernDashboardStatNumber}>{dashboardProfile.activeEvents}</Text>
            <Text style={styles.modernDashboardStatLabel}>Active</Text>
          </View>

          <View style={styles.modernDashboardStatCard}>
            <View style={styles.modernDashboardStatIconContainer}>
              <Feather name="users" size={20} color="#0277BD" />
            </View>
            <Text style={styles.modernDashboardStatNumber}>{dashboardProfile.totalAttendees}</Text>
            <Text style={styles.modernDashboardStatLabel}>Attendees</Text>
          </View>
        </View>
      </View>

      <View style={styles.modernDashboardQuickActions}>
        <SafeTouchableOpacity 
          style={styles.modernDashboardActionButton}
          onPress={() => navigation.navigate('CreateEvent')}
          activeOpacity={0.9}
        >
          <View style={styles.modernDashboardActionGradient}>
            <Feather name="plus-circle" size={22} color="#FFFFFF" />
            <Text style={styles.modernDashboardActionText}>Create Event</Text>
          </View>
        </SafeTouchableOpacity>

        <SafeTouchableOpacity 
          style={styles.modernDashboardSecondaryButton}
          onPress={loadOrganizerEvents}
          activeOpacity={0.8}
        >
          <Feather name="refresh-cw" size={20} color="#0277BD" />
          <Text style={styles.modernDashboardSecondaryText}>Refresh</Text>
        </SafeTouchableOpacity>
      </View>

      <View style={styles.modernDashboardSection}>
        <View style={styles.modernDashboardSectionHeader}>
          <Text style={styles.modernDashboardSectionTitle}>My Events</Text>
          <Text style={styles.modernDashboardSectionCount}>{organizerEvents.length}</Text>
        </View>

        {isLoading ? (
          <View style={styles.modernDashboardEmptyState}>
            <ActivityIndicator size="large" color="#0277BD" />
            <Text style={styles.modernDashboardEmptyText}>Loading your events...</Text>
          </View>
        ) : organizerEvents.length === 0 ? (
          <View style={styles.modernDashboardEmptyState}>
            <View style={styles.modernDashboardEmptyIconContainer}>
              <Feather name="calendar" size={48} color="#9CA3AF" />
            </View>
            <Text style={styles.modernDashboardEmptyTitle}>No Events Yet</Text>
            <Text style={styles.modernDashboardEmptyText}>
              Start creating amazing events and manage them all in one place
            </Text>
            <TouchableOpacity 
              style={styles.modernDashboardEmptyButton}
              onPress={() => navigation.navigate('CreateEvent')}
              activeOpacity={0.9}
            >
              <View style={styles.modernDashboardEmptyButtonGradient}>
                <Feather name="plus" size={20} color="#FFFFFF" />
                <Text style={styles.modernDashboardEmptyButtonText}>Create First Event</Text>
              </View>
            </TouchableOpacity>
          </View>
        ) : (
          <View>
            {organizerEvents.map(renderEventCard)}
          </View>
        )}
      </View>

      <View style={styles.dashboardSection}>
        <View style={styles.modernDashboardSectionHeader}>
          <Text style={styles.modernDashboardSectionTitle}>Insights</Text>
          <View style={styles.modernDashboardGrowthBadge}>
            <Feather name="trending-up" size={14} color="#10B981" />
            <Text style={styles.modernDashboardGrowthText}>+{insights.growthRate}%</Text>
          </View>
        </View>

        <View style={styles.modernDashboardInsightsGrid}>
          <View style={styles.modernDashboardInsightCard}>
            <View style={styles.modernDashboardInsightIconContainer}>
              <Feather name="eye" size={20} color="#0277BD" />
            </View>
            <Text style={styles.modernDashboardInsightValue}>{insights.totalViews.toLocaleString()}</Text>
            <Text style={styles.modernDashboardInsightLabel}>Total Views</Text>
          </View>

          <View style={styles.modernDashboardInsightCard}>
            <View style={styles.modernDashboardInsightIconContainer}>
              <Feather name="heart" size={20} color="#EF4444" />
            </View>
            <Text style={styles.modernDashboardInsightValue}>{insights.totalLikes}</Text>
            <Text style={styles.modernDashboardInsightLabel}>Favorites</Text>
          </View>

          <View style={styles.modernDashboardInsightCard}>
            <View style={styles.modernDashboardInsightIconContainer}>
              <Feather name="award" size={20} color="#F59E0B" />
            </View>
            <Text style={styles.modernDashboardInsightValue}>{insights.topCategory}</Text>
            <Text style={styles.modernDashboardInsightLabel}>Top Category</Text>
          </View>
        </View>
      </View>

      <View style={styles.dashboardSection}>
        <Text style={styles.dashboardSectionTitle}>?? Settings & Preferences</Text>
        <View style={styles.dashboardSettings}>
          <View style={styles.settingsGroup}>
            <Text style={styles.settingsGroupTitle}>Account</Text>
            <SafeTouchableOpacity 
              style={styles.dashboardSettingItem} 
              activeOpacity={0.7}
              onPress={() => navigation.navigate('UpdateProfile')}
            >
              <View style={styles.settingItemLeft}>
                <View style={[styles.settingIconContainer, { backgroundColor: '#3b82f6' }]}>
                  <Text style={styles.dashboardSettingIcon}>??</Text>
                </View>
                <View>
                  <Text style={styles.dashboardSettingText}>Update Profile</Text>
                  <Text style={styles.dashboardSettingSubtext}>Edit your personal information</Text>
                </View>
              </View>
              <Text style={styles.dashboardSettingArrow}>?</Text>
            </SafeTouchableOpacity>
            
            <SafeTouchableOpacity 
              style={styles.dashboardSettingItem} 
              activeOpacity={0.7}
              onPress={() => navigation.navigate('Verification')}
            >
              <View style={styles.settingItemLeft}>
                <View style={[styles.settingIconContainer, { backgroundColor: '#8b5cf6' }]}>
                  <Text style={styles.dashboardSettingIcon}>?</Text>
                </View>
                <View>
                  <Text style={styles.dashboardSettingText}>Verification Badge</Text>
                  <Text style={styles.dashboardSettingSubtext}>Get verified organizer status</Text>
                </View>
              </View>
              <Text style={styles.dashboardSettingArrow}>?</Text>
            </SafeTouchableOpacity>
          </View>
          
          
          <View style={styles.settingsGroup}>
            <Text style={styles.settingsGroupTitle}>Support</Text>
            <SafeTouchableOpacity 
              style={styles.dashboardSettingItem} 
              activeOpacity={0.7}
              onPress={() => navigation.navigate('HelpSupport')}
            >
              <View style={styles.settingItemLeft}>
                <View style={[styles.settingIconContainer, { backgroundColor: '#06b6d4' }]}>
                  <Text style={styles.dashboardSettingIcon}>??</Text>
                </View>
                <View>
                  <Text style={styles.dashboardSettingText}>Help & Support</Text>
                  <Text style={styles.dashboardSettingSubtext}>Get help with your events</Text>
                </View>
              </View>
              <Text style={styles.dashboardSettingArrow}>?</Text>
            </SafeTouchableOpacity>
            
            <SafeTouchableOpacity 
              style={styles.dashboardSettingItem} 
              activeOpacity={0.7}
              onPress={() => navigation.navigate('TermsPrivacy')}
            >
              <View style={styles.settingItemLeft}>
                <View style={[styles.settingIconContainer, { backgroundColor: '#6366f1' }]}>
                  <Text style={styles.dashboardSettingIcon}>??</Text>
                </View>
                <View>
                  <Text style={styles.dashboardSettingText}>Terms & Privacy</Text>
                  <Text style={styles.dashboardSettingSubtext}>Review our policies</Text>
                </View>
              </View>
              <Text style={styles.dashboardSettingArrow}>?</Text>
            </SafeTouchableOpacity>
          </View>
          
          <SafeTouchableOpacity 
            style={[styles.dashboardSettingItem, styles.logoutButton]}
            onPress={handleSignOut}
            activeOpacity={0.7}
          >
            <View style={styles.settingItemLeft}>
              <View style={[styles.settingIconContainer, { backgroundColor: '#ef4444' }]}>
                <Text style={styles.dashboardSettingIcon}>??</Text>
              </View>
              <Text style={[styles.dashboardSettingText, { color: '#ef4444' }]}>Log Out</Text>
            </View>
            <Text style={[styles.dashboardSettingArrow, { color: '#ef4444' }]}>?</Text>
          </SafeTouchableOpacity>
        </View>
      </View>

      <Modal
        visible={showCreateForm}
        transparent={true}
        animationType="slide"
        onRequestClose={() => setShowCreateForm(false)}
      >
        <View style={styles.createEventOverlay}>
          <View style={styles.createEventModal}>
            <View style={styles.createEventHeader}>
              <Text style={styles.createEventTitle}>Create New Event</Text>
              <SafeTouchableOpacity 
                onPress={() => setShowCreateForm(false)}
                style={styles.createEventClose}
              >
                <Text style={styles.createEventCloseText}>?</Text>
              </SafeTouchableOpacity>
            </View>
            
            <SafeScrollView style={styles.createEventForm}>
              <View style={styles.createEventInputGroup}>
                <Text style={styles.createEventLabel}>Event Title</Text>
                <TextInput 
                  style={styles.createEventInput}
                  placeholder="Enter event title"
                  value={newEvent.title}
                  onChangeText={(text) => setNewEvent({...newEvent, title: text})}
                />
              </View>
              
              <View style={styles.createEventInputGroup}>
                <Text style={styles.createEventLabel}>Category</Text>
                <TextInput 
                  style={styles.createEventInput}
                  placeholder="Concert, Tech Talk, Exhibition..."
                  value={newEvent.category}
                  onChangeText={(text) => setNewEvent({...newEvent, category: text})}
                />
              </View>
              
              <View style={styles.createEventInputGroup}>
                <Text style={styles.createEventLabel}>Description</Text>
                <TextInput 
                  style={styles.createEventTextArea}
                  placeholder="Describe your event..."
                  multiline={true}
                  numberOfLines={4}
                  value={newEvent.description}
                  onChangeText={(text) => setNewEvent({...newEvent, description: text})}
                />
              </View>
              
              <View style={styles.createEventInputGroup}>
                <Text style={styles.createEventLabel}>Location</Text>
                <TextInput 
                  style={styles.createEventInput}
                  placeholder="Event location"
                  value={newEvent.location}
                  onChangeText={(text) => setNewEvent({...newEvent, location: text})}
                />
              </View>
              
              <View style={styles.createEventRow}>
                <View style={styles.createEventInputHalf}>
                  <Text style={styles.createEventLabel}>Start Date</Text>
                  <TextInput 
                    style={styles.createEventInput}
                    placeholder="YYYY-MM-DD"
                    value={newEvent.startDate}
                    onChangeText={(text) => setNewEvent({...newEvent, startDate: text})}
                  />
                </View>
                <View style={styles.createEventInputHalf}>
                  <Text style={styles.createEventLabel}>End Date</Text>
                  <TextInput 
                    style={styles.createEventInput}
                    placeholder="YYYY-MM-DD"
                    value={newEvent.endDate}
                    onChangeText={(text) => setNewEvent({...newEvent, endDate: text})}
                  />
                </View>
              </View>
              
              <View style={styles.createEventInputGroup}>
                <Text style={styles.createEventLabel}>Price (Optional)</Text>
                <TextInput 
                  style={styles.createEventInput}
                  placeholder="Free or $XX.XX"
                  value={newEvent.price}
                  onChangeText={(text) => setNewEvent({...newEvent, price: text})}
                />
              </View>
              
              <View style={styles.createEventActions}>
                <SafeTouchableOpacity 
                  style={styles.createEventDraftButton}
                  onPress={() => {
                    console.log('Save as draft:', newEvent);
                    setShowCreateForm(false);
                  }}
                >
                  <Text style={styles.createEventDraftText}>Save Draft</Text>
                </SafeTouchableOpacity>
                
                <SafeTouchableOpacity 
                  style={styles.createEventPublishButton}
                  onPress={() => {
                    console.log('Publish event:', newEvent);
                    setShowCreateForm(false);
                  }}
                >
                  <Text style={styles.createEventPublishText}>Publish Event</Text>
                </SafeTouchableOpacity>
              </View>
            </SafeScrollView>
          </View>
        </View>
      </Modal>
    </SafeScrollView>
  );
}
